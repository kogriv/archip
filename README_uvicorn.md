## что такое uvicorn

UVicorn - это ASGI сервер, который предназначен для запуска приложений Python, написанных с использованием ASGI (Asynchronous Server Gateway Interface). Он позволяет эффективно обрабатывать асинхронные HTTP-запросы. Это означает, что он может обрабатывать большое количество подключений одновременно с минимальной задержкой, что делает его подходящим выбором для разработки высокопроизводительных веб-приложений.

Uvicorn поддерживает такие фреймворки, как FastAPI, Starlette, и другие, которые используют ASGI. Он обеспечивает быстрое выполнение кода Python, а также может интегрироваться с другими инструментами разработки веб-приложений, такими как Docker, Kubernetes и т.д. Uvicorn также имеет встроенную поддержку HTTP/2, что позволяет использовать преимущества этого протокола для улучшения производительности веб-приложений.

## Как работает приложение

Есть приложени app.py:
```python
from fastapi import FastAPI, UploadFile, Request
from fastapi.responses import HTMLResponse, FileResponse, RedirectResponse, JSONResponse

from fastapi.templating import Jinja2Templates

import uvicorn
import argparse
import os

app = FastAPI()

# Определение пути к текущей директории
app_path = os.path.dirname(os.path.abspath(__file__))
app_path = app_path.replace("\\", "/")

# Определение пути к директории с шаблонами относительно текущего скрипта
templates_dir = os.path.join(app_path, "templates/")
# Инициализируем шаблонизатор Jinja2
templates = Jinja2Templates(directory=templates_dir)

@app.get("/", response_class=HTMLResponse)
async def main(request: Request, request_status: str = "Not sent"):
    """
    Главная страница приложения.
    Возвращает HTML-форму для загрузки файла и ввода значений.
    """
    # Выводим сообщение при начале обработки запроса
    print("Processing request...")

    # Используем шаблонизатор для генерации HTML
    return templates.TemplateResponse("index.html",
                    {"request": request, "request_status": request_status, "app_path": app_path})

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--port", default=8000, type=int, dest="port")
    parser.add_argument("--host", default="host.docker.internal", type=str, dest="host")
 
    args = vars(parser.parse_args())

    args["host"] = "0.0.0.0"  # Изменение хоста
    args["port"] = 8000

    uvicorn.run(app, **args)
```

Что происходит (какие программные модули-библиотеки-методы-объекты запускаются) при запуске приложения. И как работает в дальнейшем приложение (сервис)

При запуске данного приложения происходит следующее:

- Импортируются необходимые модули и функции из библиотек, таких как FastAPI, UploadFile, Request, HTMLResponse, FileResponse, RedirectResponse, JSONResponse и Jinja2Templates.
Создается экземпляр FastAPI приложения под именем app.
Определяется путь к текущей директории с помощью модуля os.
Инициализируется шаблонизатор Jinja2 для работы с HTML-шаблонами.
Определяется обработчик маршрута "/", который возвращает HTML-форму, используя шаблонизатор Jinja2. При этом также выводится сообщение "Processing request..." в консоль.

- При запуске приложения с помощью uvicorn.run(app, **args), приложение начинает прослушивать указанный порт и хост. В данном случае, хост задан как "0.0.0.0", что означает, что приложение будет прослушивать все входящие запросы на всех сетевых интерфейсах. Приложение будет доступно по указанному порту.

- После запуска, приложение будет доступно по адресу, заданному хостом и портом, на который оно прослушивает. При обращении к корневому URL, приложение вернет HTML-форму, которая содержит элементы для загрузки файла и ввода значений. Запросы будут обрабатываться асинхронно, что позволяет эффективно обрабатывать множество запросов одновременно.

- Кроме того, в данном приложении используется шаблонизатор Jinja2 для генерации HTML, что позволяет упростить и структурировать процесс генерации динамического контента на стороне сервера.

## Как работает parser

В данном коде библиотека `argparse` используется для разбора аргументов командной строки, переданных при запуске скрипта.

Процесс разбора аргументов командной строки начинается с создания экземпляра ArgumentParser. В данном случае это выполняется следующей строкой:

```python
parser = argparse.ArgumentParser()
```
Далее, с помощью метода `add_argument` добавляются аргументы, которые можно передавать при запуске скрипта. Например:

```python
parser.add_argument("--port", default=8000, type=int, dest="port")
parser.add_argument("--host", default="host.docker.internal", type=str, dest="host")
```
Это позволяет определить, что при запуске скрипта можно передать аргументы `--port` и `--host`, определяющие порт и хост, на котором приложение будет запущено.

`vars(parser.parse_args())` используется для парсинга аргументов командной строки, переданных при запуске скрипта, и сохранения их в словаре.
```python
args = vars(parser.parse_args())
```
Наконец, функция `uvicorn.run(app, **args)` запускает приложение с помощью Uvicorn, используя значения, определенные в словаре args в качестве аргументов командной строки для управления хостом и портом.

Таким образом, библиотека `argparse` позволяет удобно определять и обрабатывать аргументы командной строки, что позволяет легко управлять параметрами при запуске скрипта. В данном случае она используется для установки порта и хоста, на которых будет запущено приложение.

## Примеры команды для cmd для запуска скрипта app.py с какими-то аргументами --port и --host
Если строки `args["host"] = "0.0.0.0"` и `args["port"] = 8000` закомментированы, вы можете запустить приложение с различными значениями `--port` и `--host`, передаваемыми через командную строку. Например, вот как вы можете это сделать:

Запуск скрипта с указанными значениями для порта и хоста:

```bash
python app.py --port 8000 --host "127.0.0.1"
```
Эта команда запустит приложение на порту 8000, прослушивая только подключения на локальном хосте (127.0.0.1).

Другой пример запуска с другими значениями:

```bash
python app.py --port 8888 --host "0.0.0.0"
```
Эта команда запустит приложение на порту 8888, прослушивая все подключения на всех сетевых интерфейсах.

После запуска приложения с указанными параметрами, вы можете подключиться к нему через веб-браузер, используя URL-адрес вида:

`http://адрес_хоста:порт/`

Например, если приложение было запущено на локальном хосте (127.0.0.1) и порте 8000, URL-адрес будет следующим:

`http://127.0.0.1:8000/`

А если приложение было запущено на всех сетевых интерфейсах и порту 8888, URL-адрес будет следующим:

`http://localhost:8888/`

## Как работает uvicorn.run(app, **args)
Функция uvicorn.run(app, **args) выполняет запуск веб-приложения с использованием сервера Uvicorn, где:

- uvicorn представляет собой ASGI сервер, специально предназначенный для запуска приложений, написанных с использованием ASGI (Asynchronous Server Gateway Interface).
- app представляет собой экземпляр FastAPI приложения, которое будет запущено с помощью Uvicorn.

Функция run принимает несколько аргументов, включая:

- app: Экземпляр FastAPI приложения, которое должно быть запущено.
- host: Хост, на котором будет запущено приложение. В случае **args это значение берется из переданных аргументов командной строки.
- port: Порт, на котором будет запущено приложение. Это значение также берется из переданных аргументов командной строки.
Другие параметры, связанные с настройкой сервера и приложения, такие как `debug`, `log_level`, `reload`, и так далее.

Когда `uvicorn.run(app, **args)` вызывается, Uvicorn начинает слушать входящие HTTP-запросы на указанном хосте и порте. Когда поступает HTTP-запрос, Uvicorn передает его FastAPI приложению для обработки. FastAPI обрабатывает запрос, выполняет необходимые операции и формирует ответ, который затем возвращается обратно через Uvicorn, который отправляет его обратно клиенту, отправившему запрос.

Все это происходит асинхронно, что позволяет обрабатывать несколько запросов одновременно с минимальными задержками. Кроме того, Uvicorn обеспечивает высокую производительность и может работать с различными ASGI-совместимыми фреймворками, такими как FastAPI, Starlette, и другими.

Когда говорится, что Uvicorn начинает слушать входящие HTTP-запросы на указанном хосте и порте, это означает, что Uvicorn становится активным на вашей машине и начинает прослушивать входящие сетевые запросы на определенном сетевом интерфейсе и порту.

- Хост (Host): Хост указывает на сетевой интерфейс, на котором сервер будет прослушивать входящие соединения. Указание хоста как "0.0.0.0" означает, что сервер будет прослушивать все входящие соединения на всех доступных сетевых интерфейсах. Это позволяет серверу быть доступным извне, если машина подключена к сети.

- Порт (Port): Порт - это механизм, который используется для идентификации конкретного приложения или службы на компьютере. Когда входящие запросы отправляются на определенный порт на вашей машине, сервер, прослушивающий этот порт, обрабатывает эти запросы.

При запуске Uvicorn с указанными параметрами хоста и порта, он начинает прослушивать входящие HTTP-запросы на этом конкретном хосте и порте. Если к серверу поступает HTTP-запрос, Uvicorn обрабатывает этот запрос и передает его соответствующему приложению (в данном случае FastAPI). Приложение затем обрабатывает запрос и возвращает соответствующий HTTP-ответ.

Подключение к указанному хосту и порту может осуществляться через любой сетевой интерфейс, доступный для вашей машины, например, через веб-браузер. Когда вы вводите URL в браузере, вы указываете как хост, так и порт (если он отличен от стандартного 80 для HTTP или 443 для HTTPS), чтобы браузер знал, куда отправить HTTP-запрос.

## на аппаратном уровне, на уровне операционной системы

Когда говорится, что Uvicorn "начинает прослушивать" входящие HTTP-запросы на определенном хосте и порту, это означает, что Uvicorn начинает мониторить входящие сетевые пакеты на определенном сетевом интерфейсе и порту с помощью операционной системы. Каким образом это происходит, зависит от конкретной операционной системы и структуры сети.

На уровне операционной системы, Uvicorn создает сокет, который прослушивает входящие подключения на указанном хосте и порту. Сокет представляет собой интерфейс между приложением и сетевым уровнем операционной системы. Операционная система обрабатывает входящие сетевые пакеты, отправленные на определенный хост и порт, и направляет их к соответствующему сокету, который прослушивает Uvicorn.

Uvicorn использует асинхронные методы для обработки входящих HTTP-запросов, что позволяет ему эффективно масштабироваться и обрабатывать множество запросов одновременно. Он может использовать механизмы, предоставляемые операционной системой, такие как epoll (на Linux), kqueue (на FreeBSD и macOS), или IOCP (на Windows), чтобы эффективно обрабатывать сетевые запросы.

При получении входящего HTTP-запроса на указанный хост и порт, Uvicorn принимает этот запрос, передает его соответствующему FastAPI приложению для обработки, и затем отправляет HTTP-ответ обратно клиенту через тот же сокет.

В целом, Uvicorn использует возможности операционной системы для работы с сетевыми запросами и эффективно обрабатывает их с помощью асинхронных методов и оптимизированных механизмов ввода-вывода для обеспечения высокой производительности веб-приложений.

## сокеты
Uvicorn, подобно другим ASGI-совместимым серверам, использует сокеты для прослушивания входящих подключений на Linux. В архитектуре Linux сокеты представляют собой интерфейс для взаимодействия между процессами через сеть. Архитектура сокетов в Uvicorn на Linux включает несколько ключевых компонентов:

- Создание сокета: Uvicorn создает сокет, который может быть либо потоковым (stream), либо дейтаграммным (datagram), в зависимости от типа протокола, который будет использоваться для обмена данными. Для HTTP-соединений обычно используется потоковый сокет.

- Привязка к порту и адресу: После создания сокета, Uvicorn привязывает его к определенному порту и адресу, на котором должен прослушиваться входящий трафик.

- Ожидание входящих подключений: После привязки к порту и адресу, сокет начинает ожидать входящих подключений. Это означает, что он мониторит все входящие сетевые пакеты, адресованные этому конкретному порту и адресу.

- Прием и обработка подключений: Когда сокет получает входящее соединение, Uvicorn принимает это подключение и передает его на обработку соответствующему обработчику запросов. В случае Uvicorn это означает передачу запроса FastAPI приложению для обработки.

- Отправка и получение данных: После обработки запроса FastAPI приложением, Uvicorn использует сокет для отправки HTTP-ответа обратно клиенту, и в целом для передачи данных между сервером и клиентом.

- акрытие сокета: По завершении обмена данными, сокет закрывается для освобождения ресурсов. Это важный шаг, чтобы избежать утечек памяти и других проблем, связанных с длительным использованием ресурсов сокета.

Архитектура сокетов в Uvicorn на Linux строится на стандартных сетевых возможностях операционной системы, которые обеспечивают эффективное и надежное взаимодействие между сервером и клиентом, позволяя обрабатывать множество входящих подключений одновременно.

## на каком языке написан ювикорн
Uvicorn написан на языке программирования Python. Uvicorn является ASGI-совместимым веб-сервером, разработанным на языке Python, специально для запуска приложений, написанных с использованием ASGI (Asynchronous Server Gateway Interface). Он использует возможности асинхронного программирования в Python, такие как async/await, для обработки асинхронных HTTP-запросов с высокой производительностью.

ASGI-совместимые серверы, такие как Uvicorn, обычно используются с фреймворками Python, такими как FastAPI и Starlette, которые также поддерживают ASGI. Это позволяет разработчикам создавать высокопроизводительные веб-приложения на основе Python, которые могут эффективно обрабатывать множество подключений одновременно.

## история создания ювикорн
Uvicorn был создан и разработан коллективом разработчиков, преимущественно сообществом Python, с открытым исходным кодом и активным вкладом разработчиков по всему миру. Основные вклады в разработку Uvicorn делались различными специалистами и разработчиками, знакомыми с асинхронным программированием в Python и протоколом ASGI.

Uvicorn является частью экосистемы ASGI (Asynchronous Server Gateway Interface) и веб-фреймворков Python, таких как FastAPI и Starlette. Развитие Uvicorn было стимулировано необходимостью предоставления эффективного, быстрого и асинхронного веб-сервера для работы с веб-приложениями, основанными на асинхронной архитектуре.

## инструменты для сокетов ювикорна
В основе работы веб-сервера лежит библиотека uvloop, которая является быстрой реализацией цикла событий (event loop) для Python. uvloop обеспечивает эффективную обработку сокетов и других сетевых операций в асинхронном режиме. Uvicorn использует uvloop для оптимизации сетевых операций, обеспечивая высокую производительность и эффективность веб-сервера.

Кроме того, Uvicorn также использует низкоуровневые библиотеки, такие как httptools, для обработки HTTP-запросов. httptools предоставляет эффективный и быстрый парсинг HTTP-заголовков и данных. Вместе с uvloop, эти библиотеки обеспечивают эффективную работу с сокетами и HTTP-протоколом в Uvicorn.

Uvicorn обычно работает на основе асинхронной архитектуры Python, используя asyncio и другие асинхронные возможности языка. Он использует механизмы обратного вызова (callback) и цикл событий для обработки входящих HTTP-запросов, что позволяет ему обрабатывать множество подключений одновременно с минимальными задержками.

## Библиотека uvloop
представляет собой ускоренную реализацию цикла событий (event loop) для Python, основанную на библиотеке libuv. Она создана для обеспечения более высокой производительности и эффективности в асинхронном программировании в Python. В частности, uvloop оптимизирует сетевые операции, такие как работа с сокетами, что делает ее идеальной для использования в веб-серверах и других приложениях, требующих высокой скорости и производительности.

Ниже приведены основные характеристики и информация о uvloop:

- Основа: uvloop основан на библиотеке libuv, которая предоставляет кроссплатформенный асинхронный ввод-вывод (I/O) с высокой производительностью. libuv является базовой библиотекой для таких проектов, как Node.js, и обеспечивает эффективную работу с сетью, файловой системой и другими операциями ввода-вывода.

- Преимущества: uvloop обеспечивает более высокую производительность по сравнению с обычным циклом событий Python, что делает его особенно полезным для обработки больших объемов сетевых операций, таких как обмен данными по сети.

- Создатель: uvloop была разработана и создана Денисом Букаевым (Denis Bukaev), который является разработчиком и специалистом в области асинхронного программирования и оптимизации производительности. Он создал uvloop для повышения производительности в асинхронном программировании в Python, что позволило разработчикам эффективно создавать высокопроизводительные и асинхронные приложения.

## libuv
libuv - это многоплатформенная библиотека с открытым исходным кодом, предназначенная для асинхронного ввода-вывода (I/O). Она была разработана для обеспечения высокой производительности и эффективности ввода-вывода в асинхронных приложениях. libuv предоставляет абстракцию над сетевыми операциями и операциями файловой системы, что делает ее идеальной для создания высокопроизводительных сетевых приложений и серверов.

Некоторые ключевые особенности libuv включают в себя:

- Кроссплатформенность: libuv предоставляет одинаковый интерфейс для работы с сетью и файловой системой на различных операционных системах, таких как Linux, macOS и Windows. Это обеспечивает переносимость и совместимость при разработке приложений.

- Эффективность: libuv оптимизирована для обработки больших объемов сетевых операций и ввода-вывода. Она использует оптимизированные алгоритмы и механизмы для эффективного управления множеством одновременных сетевых подключений и операций ввода-вывода.

- Поддержка асинхронных операций: libuv поддерживает асинхронные операции ввода-вывода, что позволяет разработчикам создавать отзывчивые и эффективные приложения, способные обрабатывать множество операций одновременно без блокировки основного потока выполнения.

libuv используется в различных проектах, включая Node.js, и служит основой для реализации асинхронных операций ввода-вывода во многих современных сетевых и асинхронных приложениях.

Библиотека libuv была создана Майклом Далласом (Michael Dawson) и Бартом Сосынским (Bert Belder) в 2011 году. libuv написана на языке программирования C, что обеспечивает высокую производительность и эффективность. Она предоставляет множество функций для работы с сетевыми операциями и операциями ввода-вывода, таких как создание сокетов, управление потоками, а также асинхронные операции файловой системы.

libuv изначально была создана для использования в проекте Node.js для обеспечения кроссплатформенной поддержки асинхронных сетевых операций и операций ввода-вывода. Она играет важную роль в обеспечении высокой производительности и эффективности в сетевых и асинхронных приложениях, написанных на C и других языках программирования.

Благодаря своей эффективности и многоплатформенной поддержке, libuv стала широко используемой библиотекой в различных проектах, требующих обработки сетевых операций и операций ввода-вывода с высокой производительностью и эффективностью.